# **Отчет по развертыванию, использованию и проверке CVAT (Computer Vision Annotation Tool)**

Этот документ описывает процесс установки, базовой настройки, использования и проверки инструмента разметки данных CVAT. Инструкции ориентированы на локальное развертывание с использованием **Docker и Docker Compose**.

## 1. Развертывание CVAT

### 1.1. Предварительные требования
*   **Установленные Docker и Docker Compose:**
    *   **Windows/macOS:** Docker Desktop (включает Docker Compose).
    *   **Linux:** Docker Engine и Docker Compose (могут устанавливаться отдельно). Рекомендуется убедиться, что текущий пользователь добавлен в группу `docker`.
*   **Установленный Git:** Необходим для клонирования официального репозитория CVAT.
*   **Доступ в Интернет:** Требуется для скачивания Docker-образов компонентов CVAT.
*   **Python 3.x (опционально, для скрипта проверки):** С необходимыми библиотеками, такими как `Pillow` для работы с изображениями, `xml.etree.ElementTree` для парсинга CVAT XML (или `json` для COCO JSON), и `opencv-python` для визуализации.

### 1.2. Выбор способа развертывания
Для локального развертывания CVAT был выбран официально рекомендуемый метод с использованием **Docker Compose**. Этот подход позволяет корректно запустить все взаимосвязанные сервисы, из которых состоит CVAT (веб-сервер, база данных, кэш, фоновые обработчики и т.д.), и обеспечивает персистентное хранение данных с помощью именованных Docker-томов (volumes).

### 1.3. Шаги развертывания

1.  **Клонирование официального репозитория CVAT:**
    Откройте терминал и выполните следующие команды:
    ```bash
    git clone https://github.com/cvat-ai/cvat.git
    cd cvat
    ```

2.  **Запуск CVAT с помощью Docker Compose:**
    Находясь в корневой директории клонированного репозитория `cvat`, выполните команду:
    ```bash
    docker compose up -d
    ```
    **Разбор команды:**
    *   `docker compose up`: Собирает (если необходимо) и запускает все сервисы, определенные в файлах `docker-compose.yml` и `docker-compose.override.yml` (если он существует и используется).
    *   `-d` (detached): Запускает контейнеры в фоновом режиме.

    **Основные сервисы, запускаемые CVAT (согласно `docker-compose.yml`):**
    *   `cvat_server`: Основной Django-сервер приложения CVAT, обрабатывающий API-запросы.
    *   `cvat_ui`: Frontend-приложение (на React), с которым взаимодействует пользователь.
    *   `cvat_db`: База данных PostgreSQL для хранения метаданных проектов, задач, аннотаций и пользователей.
    *   `redis`: Используется как кэш и брокер сообщений для фоновых задач Celery.
    *   `cvat_worker_annotation`, `cvat_worker_import`, `cvat_worker_export`: Фоновые обработчики (Celery workers) для выполнения длительных операций, таких как создание аннотаций, импорт/экспорт данных.
    *   `traefik` (или аналогичный реверс-прокси): Обеспечивает маршрутизацию запросов к `cvat_ui` и `cvat_server`, а также может использоваться для SSL-терминации.
    *   *Опционально могут запускаться сервисы для ML-интеграции, такие как Nuclio или OpenVINO Model Server, в зависимости от конфигурации.*

3.  **Проверка статуса контейнеров:**
    После запуска убедитесь, что все контейнеры успешно стартовали и работают:
    ```bash
    docker compose ps
    ```
    Все сервисы должны иметь статус `Up` или `Running`.

4.  **Создание аккаунта суперпользователя:**
    CVAT не предлагает создание первого пользователя через веб-интерфейс при первом запуске. Поэтому необходимо создать учетную запись администратора (суперпользователя) через командную строку, выполнив команду на хост-машине:
    ```bash
    docker compose exec cvat_server bash -ic "python3 ~/manage.py createsuperuser --username <your_admin_username> --email <your_admin_email>"
    ```
    Замените `<your_admin_username>` и `<your_admin_email>` на желаемые значения. Затем система запросит ввод и подтверждение пароля.

5.  **Доступ к CVAT:**
    После успешного выполнения предыдущих шагов, веб-интерфейс CVAT должен быть доступен в браузере по адресу `http://localhost:8080` (если порт 8080 не был изменен). Вход в систему осуществляется с использованием учетных данных суперпользователя, созданных на предыдущем шаге.

### 1.4. Персистентность данных
CVAT использует именованные Docker-тома (volumes) для обеспечения сохранности данных. Эти тома управляются Docker и сохраняют данные даже при остановке и удалении контейнеров (но не при удалении самих томов). Основные тома, определенные в `docker-compose.yml`, включают:
*   `cvat_db`: Хранит данные базы PostgreSQL.
*   `cvat_data`: Хранит загруженные пользователем файлы (изображения, видео), временные файлы, специфичные данные задач.
*   `cvat_keys`: Используется для хранения ключей, например, для подписи JWT-токенов.
*   `cvat_logs`: Хранит логи серверной части CVAT.
*   `redis_data`: Хранит данные состояния Redis.

### 1.5. Возможные сложности и их решения при развертывании и настройке

*   **Сложность 1: Конфликт портов.**
    *   **Симптом:** CVAT не запускается корректно, или веб-интерфейс недоступен по адресу `http://localhost:8080`. Просмотр логов контейнера `traefik` (или `cvat_proxy`, в зависимости от версии `docker-compose.yml`) командой `docker compose logs traefik` может показать ошибки, связанные с невозможностью привязаться к порту (например, "address already in use").
    *   **Причина:** Порт `8080` (или другой порт, используемый CVAT) уже занят другим приложением на хост-машине.
    *   **Решение:** Можно изменить порт, который CVAT использует на хост-машине. Для этого необходимо создать файл `.env` в корневой директории клонированного репозитория `cvat` (рядом с `docker-compose.yml`) и добавить в него строку, например:
        ```env
        CVAT_PORT=8081 
        ```
        После этого необходимо остановить текущие контейнеры (`docker compose down`) и запустить их снова (`docker compose up -d`). CVAT станет доступен по адресу `http://localhost:8081`.

*   **Сложность 2: Нехватка системных ресурсов для Docker.**
    *   **Симптом:** Некоторые контейнеры CVAT (особенно `cvat_server` или `cvat_db`) могут неожиданно останавливаться, перезапускаться или работать нестабильно. В логах контейнеров могут быть ошибки, связанные с нехваткой памяти (OOM killer).
    *   **Причина:** Недостаточный объем оперативной памяти (RAM) или процессорных ядер (CPU), выделенных для Docker Desktop (на Windows/macOS) или доступных на Linux-хосте. CVAT, состоящий из множества сервисов, может быть требователен к ресурсам.
    *   **Решение:** В настройках Docker Desktop увеличить лимиты выделяемых ресурсов (RAM рекомендуется не менее 8 ГБ для комфортной работы, количество CPU – по возможности). Для Linux убедиться, что на хосте достаточно свободных ресурсов.

*   **Замечание по начальной навигации и структуре:** Интерфейс CVAT, в отличие от Label Studio, может показаться менее интуитивным для пользователя, впервые столкнувшегося с ним. Иерархическая структура (Организация -> Проект -> Задача -> Работа) требует некоторого времени на осмысление и привыкание. Процесс создания сущностей (например, проекта, затем задачи внутри него, затем определение меток и загрузка файлов) ощущается как более многоступенчатый по сравнению с более прямолинейным подходом в Label Studio для простых проектов.

## 2. Тестовая разметка: Детекция кошек на изображениях

### 2.1. Создание проекта и задачи
*   **Проект:** В веб-интерфейсе CVAT, в разделе "Projects", был создан новый проект с именем `Cats_Detection_Project`. Проекты в CVAT служат для группировки связанных задач.
*   **Задача (Task):** Внутри созданного проекта была создана новая задача:
    *   **Имя задачи:** `Cats_Batch_01`.
    *   **Привязка к проекту:** Задача была ассоциирована с проектом `Cats_Detection_Project`.
    *   **Замечание по настройке задачи:** Процесс добавления файлов и определения меток (labels) в рамках создания задачи в CVAT показался более детализированным и требующим большего количества шагов по сравнению с аналогичным процессом в Label Studio. Концепция автоматического разделения задачи на одну или несколько "Работ" (Jobs) также является особенностью CVAT, требующей осмысления.

### 2.2. Подготовка и импорт датасета
*   **Данные:** Для тестовой разметки был использован тот же набор из 14 изображений кошек, что и при тестировании Label Studio, для обеспечения сопоставимости.
*   **Источник:** Изображения были собраны с общедоступных фотостоков (например, Pexels, Unsplash).
*   **Формат:** Все изображения были в формате `.jpg`.
*   **Процесс импорта:** Изображения были загружены в задачу `Cats_Batch_01` на этапе ее создания через интерфейс CVAT, используя опцию "Select files" -> "My computer".

### 2.3. Настройка меток (Labels)
В конструкторе меток задачи `Cats_Batch_01` были определены следующие классы объектов для детекции с использованием ограничивающих прямоугольников:
```
- Label 1:
  - Name: Cat
  - Type: Rectangle (тип фигуры по умолчанию для новой метки, если не указано иное)
- Label 2:
  - Name: Cats_Group 
  - Type: Rectangle 
```
*Каждой метке можно также присвоить уникальный цвет для удобства визуализации.*

### 2.4. Выполнение разметки
*   После создания задачи, автоматически созданная работа (Job) была открыта для аннотирования.
*   Все 14 импортированных изображений были последовательно размечены.
*   Для каждого изображения выполнялись следующие действия:
    1.  Выбор инструмента "Draw new rectangle" (Нарисовать новый прямоугольник) на панели инструментов (или использование горячих клавиш `N` для активации режима создания новой фигуры, затем `R` для выбора прямоугольника).
    2.  Выбор соответствующей метки ("Cat" или "Cats_Group") на панели меток.
    3.  Отрисовка ограничивающего прямоугольника вокруг каждого целевого объекта.
    4.  Сохранение аннотаций (CVAT имеет функцию автосохранения, но рекомендуется также периодически использовать `Ctrl+S` или кнопку "Save").
*   **Замечание по интерфейсу разметки:** Основные инструменты аннотирования (прямоугольник, полигон) в CVAT работают стабильно и предоставляют хорошую функциональность. Однако, навигация по интерфейсу и освоение полного набора горячих клавиш требуют времени. Для нового пользователя некоторые действия или оптимальные последовательности операций могут быть не сразу очевидны, что на начальном этапе может несколько замедлять процесс разметки по сравнению с более простыми интерфейсами.

## 3. Экспорт и проверка разметки

### 3.1. Экспорт данных
*   После завершения разметки всех изображений в работе, аннотации были экспортированы со страницы задачи `Cats_Batch_01`.
*   Для этого использовалась кнопка "Actions" (Действия) -> "Export task dataset" (Экспортировать датасет задачи).
*   **Выбранный формат экспорта:** **CVAT for images (XML)**. Этот формат является нативным для CVAT и хорошо подходит для сохранения всей информации об аннотациях, включая атрибуты и структуру задачи.
*   Был скачан ZIP-архив, содержащий файл `annotations.xml` и, опционально (если была выбрана соответствующая опция при экспорте), папку с исходными изображениями.

### 3.2. Проверка разметки с помощью Python-скрипта
Для визуальной проверки корректности экспортированных аннотаций в формате CVAT XML был разработан Python-скрипт с использованием библиотеки `xml.etree.ElementTree` для парсинга XML и `opencv-python` для загрузки и отображения изображений с наложенными аннотациями.

**Ключевые особенности и сложности при разработке скрипта для CVAT XML:**

1.  **Структура CVAT XML:** Формат `annotations.xml` имеет иерархическую структуру:
    *   Корневой элемент `<annotations>`.
    *   Элементы `<image>` для каждого изображения, содержащие атрибуты `id`, `name` (имя файла), `width`, `height`.
    *   Внутри каждого `<image>` могут находиться элементы `<box>` (для прямоугольников), `<polygon>`, `<polyline>`, `<points>`, `<cuboid>`, каждый со своими атрибутами (например, `label`, `xtl`, `ytl`, `xbr`, `ybr` для `<box>`, или `points` для `<polygon>`).
    *   Скрипту необходимо корректно парсить эту XML-структуру, извлекая информацию об изображениях и соответствующих им аннотациях.

2.  **Пути к изображениям:** Имя файла изображения берется из атрибута `name` тега `<image>`. Скрипту нужно было корректно сопоставить это имя с локальным путем к файлам изображений (которые либо экспортировались вместе с XML, либо доступны отдельно).

**Пример Python-скрипта для визуализации (концептуальный):**
```python
import xml.etree.ElementTree as ET
import cv2
import os

# --- НАСТРОЙКИ ---
CVAT_XML_PATH = "path/to/your/annotations.xml" # Путь к annotations.xml
IMAGES_DIR = "path/to/your/images_directory/" # Путь к папке с изображениями

MAX_DISPLAY_WIDTH = 1280
MAX_DISPLAY_HEIGHT = 720
WINDOW_NAME_PREFIX = "CVAT Annotation Viewer"
# --- КОНЕЦ НАСТРОЕК ---

def visualize_cvat_xml_annotations(xml_path, images_base_path):
    if not os.path.exists(xml_path):
        print(f"Ошибка: Файл XML аннотаций не найден: {xml_path}")
        return
    if not os.path.isdir(images_base_path):
        print(f"Ошибка: Директория с изображениями не найдена: {images_base_path}")
        return

    tree = ET.parse(xml_path)
    root = tree.getroot()

    image_annotations = {}
    for image_tag in root.findall('image'):
        image_id = image_tag.get('id')
        image_name = image_tag.get('name')
        # Иногда имя может содержать подпапки, если они были при импорте
        # Убедимся, что берем только имя файла для поиска в images_base_path
        base_image_name = os.path.basename(image_name)
        image_width = int(image_tag.get('width'))
        image_height = int(image_tag.get('height'))
        
        annotations_for_image = []
        for box_tag in image_tag.findall('box'):
            label = box_tag.get('label')
            xtl = float(box_tag.get('xtl'))
            ytl = float(box_tag.get('ytl'))
            xbr = float(box_tag.get('xbr'))
            ybr = float(box_tag.get('ybr'))
            annotations_for_image.append({
                'label': label, 
                'xtl': xtl, 'ytl': ytl, 
                'xbr': xbr, 'ybr': ybr,
                'type': 'box'
            })
        # Здесь можно добавить парсинг других типов аннотаций (polygon, polyline и т.д.)
        image_annotations[base_image_name] = {
            'width': image_width, 
            'height': image_height, 
            'annotations': annotations_for_image
        }

    sorted_image_names = sorted(image_annotations.keys()) # Для последовательного отображения

    for i, image_name in enumerate(sorted_image_names):
        print(f"\nОбработка изображения: {image_name} ({i+1}/{len(sorted_image_names)})")
        full_image_path = os.path.join(images_base_path, image_name)

        if not os.path.exists(full_image_path):
            print(f"  Ошибка: Файл изображения не найден: {full_image_path}")
            continue
        
        original_image = cv2.imread(full_image_path)
        if original_image is None:
            print(f"  Ошибка: Не удалось загрузить изображение: {full_image_path}")
            continue
        
        display_image = original_image.copy()
        img_data = image_annotations[image_name]

        for ann in img_data['annotations']:
            if ann['type'] == 'box':
                x1, y1, x2, y2 = int(ann['xtl']), int(ann['ytl']), int(ann['xbr']), int(ann['ybr'])
                label_text = ann['label']
                color = (0, 255, 0) # Зеленый
                line_thickness = max(1, int(min(img_data['width'], img_data['height']) / 300))
                font_scale = max(0.4, min(img_data['width'], img_data['height']) / 1000)

                cv2.rectangle(display_image, (x1, y1), (x2, y2), color, line_thickness)
                (text_w, text_h), baseline = cv2.getTextSize(label_text, cv2.FONT_HERSHEY_SIMPLEX, font_scale, line_thickness)
                text_y = y1 - 10 if y1 - 10 > text_h else y1 + text_h + baseline + 5
                cv2.putText(display_image, label_text, (x1, text_y), 
                            cv2.FONT_HERSHEY_SIMPLEX, font_scale, color, line_thickness)
        
        # Масштабирование для отображения
        if MAX_DISPLAY_WIDTH > 0 and MAX_DISPLAY_HEIGHT > 0:
            h_disp, w_disp = display_image.shape[:2]
            scale = min(MAX_DISPLAY_WIDTH / w_disp, MAX_DISPLAY_HEIGHT / h_disp)
            if scale < 1:
                new_w, new_h = int(w_disp * scale), int(h_disp * scale)
                resized_display_image = cv2.resize(display_image, (new_w, new_h), interpolation=cv2.INTER_AREA)
            else:
                resized_display_image = display_image
        else:
            resized_display_image = display_image

        current_window_name = f"{WINDOW_NAME_PREFIX} - {image_name}"
        cv2.imshow(current_window_name, resized_display_image)
        
        print(f"  Отображено изображение {image_name}. Нажмите любую клавишу для следующего, ESC для выхода.")
        key = cv2.waitKey(0)
        
        try:
            cv2.destroyWindow(current_window_name)
        except cv2.error as e:
            print(f"  Info: Не удалось закрыть окно '{current_window_name}' (возможно, закрыто пользователем): {e}")

        if key == 27:  # ESC
            print("Выход по требованию пользователя.")
            break
            
    cv2.destroyAllWindows()
    print("\nПроверка завершена.")

if __name__ == "__main__":
    # Убедитесь, что пути ЗАМЕНЕНЫ на актуальные перед запуском
    if CVAT_XML_PATH == "path/to/your/annotations.xml" or \
       IMAGES_DIR == "path/to/your/images_directory/":
        print("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")
        print("!!! ВНИМАНИЕ: Пожалуйста, обновите пути в скрипте (CVAT_XML_PATH и IMAGES_DIR) !!!")
        print("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")
    else:
        visualize_cvat_xml_annotations(CVAT_XML_PATH, IMAGES_DIR)

```
**Результат проверки:** Визуальный осмотр изображений с наложенными аннотациями, сгенерированными скриптом, подтвердил, что разметка была выполнена корректно, и ограничивающие рамки соответствовали размеченным объектам (кошкам) на изображениях.

## 4. Впечатления от первого опыта использования CVAT

*   **Удобство интерфейса:**
    *   **Развертывание и базовая навигация:** Процесс развертывания CVAT с использованием Docker Compose является стандартным и достаточно простым при следовании официальной документации. Однако первоначальная навигация по веб-интерфейсу CVAT (различие между Организациями, Проектами, Задачами и Работами; управление пользователями; подключение облачных хранилищ) требует определенного времени на освоение и может показаться менее интуитивной по сравнению с более простыми инструментами, особенно для пользователей без опыта работы с комплексными системами управления данными.
    *   **Интерфейс аннотирования:** Сами инструменты аннотирования (прямоугольники, полигоны и др.) являются функциональными и предоставляют множество опций (атрибуты, отслеживание объектов на видео, автоматическая интерполяция). Обширный набор горячих клавиш значительно ускоряет работу после их изучения и привыкания. Однако для нового пользователя некоторые функции и оптимальные рабочие процессы могут быть не сразу очевидны без предварительного изучения документации или обучающих материалов.

*   **Понятность настроек:**
    *   **Создание проекта/задачи:** Процесс создания задач и настройки меток (включая их атрибуты) в CVAT ощущается как более "инженерный" и гранулярный, но менее дружелюбный к новичку, чем, например, в Label Studio. Конструктор меток и атрибутов мощный, но его интерфейс мог бы быть более наглядным и простым для базовых случаев. Концепция разделения Задач на "Работы" (Jobs), хотя и полезна для крупных проектов и команд, вносит дополнительный уровень абстракции, который может быть избыточен для небольших индивидуальных проектов.
    *   **Экспорт данных:** CVAT предлагает впечатляющее количество форматов экспорта, что является большим преимуществом. Выбор нужного формата и его опций понятен.

*   **Возникшие вопросы или трудности при самой разметке и работе:**
    *   **Интерфейс:** Основная трудность заключалась в адаптации к общей философии и структуре организации данных и рабочих процессов в CVAT. Некоторые действия, которые в других, более простых инструментах выполняются интуитивно в один-два клика, в CVAT могут требовать навигации по нескольким меню или понимания специфической логики инструмента.
    *   **Ощущение "избыточности" для простых задач:** Для быстрой разметки небольшого набора изображений с простыми требованиями (например, только Bounding Box'ы одного-двух классов) CVAT может показаться несколько перегруженным функциями и настройками.

*   **Сравнение с Label Studio (на основе опыта с обоими инструментами):**
    *   **Установка и развертывание:** Оба инструмента легко разворачиваются через Docker. CVAT с Docker Compose представляет собой более многокомпоннентную систему, что отражает его более сложную архитектуру, но сам процесс запуска стандартен.
    *   **Импорт данных и настройка задачи:** Для быстрого старта простого проекта Label Studio часто выигрывает в простоте и интуитивности. CVAT предлагает более детальный и гранулярный контроль над настройками задачи и меток, что полезно для сложных проектов, но требует больше времени на освоение для базовых операций.
    *   **Интерфейс аннотирования:** Для сложных задач компьютерного зрения (особенно видеоаннотирование, работа с 3D-кубоидами, продвинутый трекинг) и для опытных команд разметчиков CVAT предлагает более специализированные и мощные инструменты "из коробки". Label Studio, благодаря своей XML-гибкости, может быть адаптирован под многие задачи, но его базовый инструментарий для CV может быть проще. CVAT ощущается как инструмент, более ориентированный на производственные процессы разметки и работу в команде.
    *   **Экспорт данных:** Оба инструмента поддерживают все основные популярные форматы. CVAT имеет несколько более широкий нативный список форматов, специфичных для компьютерного зрения.
    *   **Общее впечатление:**
        *   **Label Studio:** Представляется отличным выбором для быстрого прототипирования, небольших и средних проектов, а также для задач, где ключевую роль играет универсальность (текст, аудио, временные ряды) и гибкость настройки интерфейса "на лету" через XML. Более дружелюбен к новичкам для простых задач.
        *   **CVAT:** Является мощным, многофункциональным инструментом, лучше подходящим для крупных проектов по компьютерному зрению, командной работы, и задач, требующих продвинутых функций аннотирования (например, интерполяция треков на видео, работа с кубоидами, использование встроенных AI-ассистентов). Требует больше времени на освоение, его интерфейс и структура могут показаться менее интуитивными для новых пользователей или для очень простых задач, но он предлагает более строгую организацию рабочего процесса и мощный контроль.

## 5. Заключение
Задача по развертыванию CVAT с использованием Docker Compose, выполнению тестовой разметки набора изображений, экспорту аннотаций и их последующей визуальной проверке была успешно выполнена. В ходе работы был получен ценный практический опыт взаимодействия с CVAT, который продемонстрировал его как мощный, но требующий определенного времени на освоение и привыкание инструмент, ориентированный на сложные задачи компьютерного зрения и командную работу. Процесс развертывания, использования и ключевые наблюдения были задокументированы в настоящем отчете. Сделан вывод, что для простых задач и быстрого старта Label Studio может быть более предпочтительным вариантом благодаря своей интуитивности и гибкости, в то время как CVAT является более подходящим решением для масштабных и комплексных проектов в области компьютерного зрения, где важны продвинутые функции аннотирования и строгая организация рабочего процесса.
